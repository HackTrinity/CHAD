image: $chad_gateway_image
environment:
  - __CAP_ADD=NET_ADMIN
  - CHALLENGE_POOL=$chad_challenge_pool
  - PROXY=$chad_gateway_proxy
  - DOMAIN=$chad_challenge_domain
  - INSTANCE_ID=$chad_id
  - CONFIG_PASSWORD_FILE=/run/secrets/config_password
deploy:
  labels:
    - 'traefik.enable=true'
    - 'traefik.tcp.routers.chad_${chad_id}_gw.rule=HostSNI(`CONNECT:${chad_id}.${chad_challenge_domain}:1194`)'
    - 'traefik.tcp.routers.chad_${chad_id}_gw.entrypoints=http'
    - 'traefik.tcp.services.chad_${chad_id}_gw.loadbalancer.server.port=1194'
    - 'traefik.http.routers.chad_${chad_id}_gwconf.rule=Host(`${chad_id}.${chad_challenge_domain}`)'
    - 'traefik.http.routers.chad_${chad_id}_gwconf.entrypoints=http'
    - 'traefik.http.services.chad_${chad_id}_gwconf.loadbalancer.server.port=80'
networks:
  - default
  - $chad_traefik_network
secrets:
  - config_password
